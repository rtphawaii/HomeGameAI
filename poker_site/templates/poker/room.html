<!doctype html><html><head><meta charset="utf-8"><title>{{ room.name }}</title></head>
<body>
  <h2>{{ room.name }}</h2>
  <p>Room ID: <code>{{ room.slug }}</code></p>

  <div id="chat-log" style="height:200px;overflow:auto;border:1px solid #ccc;margin:10px 0;padding:8px;"></div>
  <input id="chat-message-input" placeholder="Type a message">
  <button id="send">Send</button>

  <div style="margin-top:12px;">
    <select id="player-select"></select>
    <input id="amount-input" type="number" step="0.01" placeholder="Amount">
    <button id="add-btn">Add Balance</button>
  </div>

  <script>
    const userId = "{{ user_id }}";
    const roomId = "{{ room.slug }}";
    const wsScheme = location.protocol === "https:" ? "wss" : "ws";
    const chatSocket = new WebSocket(`${wsScheme}://${location.host}/ws/chat/${encodeURIComponent(roomId)}/?user_id=${encodeURIComponent(userId)}`);

    document.getElementById('send').onclick = () => {
      const inp = document.getElementById('chat-message-input');
      if (chatSocket.readyState === WebSocket.OPEN)
        chatSocket.send(JSON.stringify({ message: inp.value }));
      inp.value = "";
    };

    document.getElementById('add-btn').onclick = () => {
      const amount = parseFloat(document.getElementById('amount-input').value);
      const target_user_id = document.getElementById('player-select').value || userId;
      if (isNaN(amount) || amount <= 0) return alert("Enter a positive amount");
      chatSocket.send(JSON.stringify({ type: "add_balance", target_user_id, amount }));
      document.getElementById('amount-input').value = "";
    };

    chatSocket.onmessage = (e) => {
      const data = JSON.parse(e.data);
      if (data.message) {
        const log = document.getElementById('chat-log');
        const div = document.createElement('div');
        div.textContent = data.message;
        log.appendChild(div);
        log.scrollTop = log.scrollHeight;
      }
      if (data.player && data.player.user_id) {
        const sel = document.getElementById('player-select');
        if (![...sel.options].some(o => o.value === data.player.user_id)) {
          const opt = document.createElement('option');
          opt.value = data.player.user_id;
          opt.textContent = `${data.player.name || data.player.user_id} â€” $${data.player.balance}`;
          sel.appendChild(opt);
        }
      }
    };
  </script>
</body></html>
